from unittest.mock import MagicMock

from transformers import BloomTokenizerFast

from piqard.language_models import BLOOM176bAPI

class TestFAISSRetriever():

    def test_init(self, monkeypatch):
        language_model = BLOOM176bAPI("stop_token", 0.01, top_k=2)
        assert language_model.stop_token == "stop_token"
        assert language_model.parameters["temperature"] == 0.01
        assert language_model.parameters["top_k"] == 2
        assert str(language_model) == "BLOOM 176b huggingface.co API"

    def test_query(self):
        language_model = BLOOM176bAPI("\n")
        res = language_model.query("payload")

    # def test_preprocess_cut(self):
    #     prompt = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. In blandit posuere sapien non dignissim. Quisque vulputate tortor et vulputate euismod. Duis in mauris eu tortor ultricies finibus ac et ipsum. Pellentesque dignissim nibh nibh, quis sodales turpis placerat vel. Quisque lobortis molestie orci, vel varius urna pharetra a. Cras nisi mi, sodales id est quis, cursus viverra leo. Praesent et eros velit. Mauris pulvinar pharetra semper. Aenean non mattis sapien, sed elementum nulla. Pellentesque pretium, nunc et fringilla bibendum, quam sem sodales leo, et lacinia nunc turpis dignissim felis. Mauris luctus urna ac aliquam finibus.Quisque aliquam feugiat arcu, sit amet convallis metus facilisis sit amet. Nulla eget laoreet magna. Donec vel consequat metus. Curabitur congue blandit felis eu dapibus. Cras luctus ex nulla. Phasellus eu eros sed arcu congue finibus. Morbi varius tristique est, nec vestibulum sapien feugiat id. Etiam luctus lectus sed eros malesuada ultricies. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce consectetur dolor odio, vitae scelerisque ipsum lacinia a. Integer a ex quis velit mollis semper.Suspendisse a augue volutpat, volutpat ipsum non, lacinia lacus. Duis volutpat ultrices laoreet. Nulla id tincidunt arcu, ac iaculis sapien. In dolor augue, congue nec elit ac, ullamcorper viverra tellus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Cras ante arcu, blandit sed magna non, sollicitudin molestie felis. Morbi auctor accumsan ex at rhoncus. Proin sed elit eget tortor facilisis condimentum iaculis pellentesque quam. Phasellus sapien ante, condimentum sit amet pharetra scelerisque, suscipit sed magna. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Donec sit amet scelerisque lectus, vitae congue augue. Proin iaculis, massa nec varius hendrerit, velit metus feugiat nisi, vitae interdum orci nunc vitae dui.Curabitur sed erat in turpis vehicula scelerisque volutpat non nunc. Nulla facilisi. Integer vitae elit mi. Maecenas non iaculis nunc. Suspendisse vel magna quis leo ornare volutpat. Nulla a arcu massa. Pellentesque ultrices in leo et maximus. Fusce vestibulum ipsum nec quam porttitor viverra. Praesent a lobortis mi. In placerat nisi vitae aliquam facilisis. Nunc ultricies arcu massa, ac luctus urna efficitur eu. Proin luctus nunc nulla, ut efficitur nisl aliquam sed. Pellentesque nec neque vel lorem fermentum tempus sed at nunc.Fusce tempus urna at eros tempus, vel pharetra elit bibendum. Fusce congue ante at diam mollis, eu malesuada magna condimentum. Pellentesque tincidunt, elit nec consequat consequat, velit purus viverra velit, at iaculis elit arcu eget ex. Morbi at venenatis ipsum. Curabitur vel odio nec sem porttitor euismod. Sed mi ante, tincidunt ac nibh nec, scelerisque sodales sem. Suspendisse tempus sapien purus, eget tincidunt metus condimentum vitae. Integer rutrum augue sem, a efficitur magna congue vitae. Morbi tempus tortor non diam pulvinar rutrum. Nunc neque leo, tempor vel placerat non, ullamcorper ac ligula. Nullam aliquet eget lacus ut egestas. Donec finibus ac leo non elementum. Nulla ultricies lectus mi, vel elementum erat accumsan et. Nunc volutpat volutpat urna, non viverra tortor scelerisque et. Phasellus dictum ligula scelerisque, pellentesque nisl sed, vestibulum mauris.Vivamus lobortis est sed augue porta tristique. Integer bibendum quam non erat viverra dapibus. Aliquam dictum, enim vitae ultrices maximus, elit lectus eleifend mauris, sed iaculis ex lacus eget enim. Morbi eu urna consectetur ante volutpat sollicitudin venenatis sed enim. Nullam tincidunt turpis ut est porta mollis. Quisque vel libero tincidunt, venenatis ipsum quis, porttitor nisl. Vestibulum tristique nibh turpis, in eleifend diam hendrerit sed. Nunc fermentum tortor vitae est fermentum tempor. Sed commodo ultrices molestie.Quisque nec volutpat neque, nec imperdiet sapien. Nunc bibendum eros porta, rutrum lectus sed, dignissim neque. Curabitur eu mauris ut lectus aliquet hendrerit. Integer ac sem ut tortor laoreet scelerisque. Aliquam interdum tincidunt congue. Quisque elementum enim quis ligula pellentesque, in egestas sem lobortis. Nam pretium tincidunt quam non vestibulum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Vivamus accumsan in nisl et pellentesque.Cras id quam ultricies, semper odio eu, porttitor nunc. Pellentesque nec ultrices sapien, ac sodales lorem. Vivamus sollicitudin elementum lectus. Cras ultricies eu sem in fringilla. Fusce placerat interdum velit ac maximus. Cras maximus diam et sem laoreet mollis. In a pretium nulla, at bibendum metus. Sed hendrerit massa vel felis pharetra commodo. Nunc lobortis odio porttitor porta dapibus. Phasellus at eleifend ex. Nam vitae nisi fermentum, auctor felis at, pretium orci.In vitae faucibus mauris. Pellentesque at tellus dignissim, faucibus erat at, vulputate ipsum. Pellentesque eu rhoncus nisi, et ornare nisl. Cras molestie erat ac auctor ultrices. Integer pellentesque nunc sapien, in accumsan augue tincidunt a. Etiam mattis est ex, a maximus magna interdum eu. Nunc ac ex diam. Etiam nec enim vitae lectus blandit feugiat vitae sit amet mauris. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos.Aliquam sed hendrerit tellus. Cras nec enim leo. Donec nec placerat nibh, id faucibus felis. Sed hendrerit non lectus vel feugiat. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Proin egestas gravida dignissim. Ut vulputate, sem sed facilisis consequat, tellus arcu mattis sapien, a tincidunt ex metus id nibh. Quisque accumsan est nec nisl cursus, lacinia fermentum magna semper. Nam aliquet leo at tincidunt mattis.Curabitur egestas eu lectus at tempus. Fusce interdum vulputate sapien, quis consectetur nulla. Nullam semper odio ipsum, sit amet luctus turpis egestas ut. Nullam vel molestie libero, at luctus tellus. Aliquam semper ex quam, in tristique lectus malesuada eget. Proin id dictum ipsum. Fusce dapibus porta purus, cursus hendrerit ligula. Suspendisse gravida cursus ligula ut commodo. Phasellus sed elit luctus, pulvinar tortor non, tincidunt felis. Duis suscipit nisi vitae metus eleifend, in pretium nunc interdum. Nunc non lacus neque. Duis odio velit, aliquet non purus a, sollicitudin sodales mauris. Sed quis euismod neque, non commodo ex. Maecenas bibendum fermentum magna. Phasellus tellus dui, condimentum id turpis et, ullamcorper semper urna.Donec scelerisque mauris a auctor maximus. Sed velit ligula, bibendum quis dui nec, egestas maximus dui. Suspendisse eu dictum eros, eu hendrerit sapien. Vivamus laoreet lacinia volutpat. Maecenas accumsan erat odio, id pellentesque nibh pellentesque consequat. Phasellus eleifend dui viverra lacus finibus pulvinar. Maecenas viverra sit amet erat non laoreet. Ut interdum lacinia felis, id aliquet nunc commodo eu. Morbi varius risus nisl, ac volutpat purus dignissim sed. Ut nec ligula congue, euismod est ac, imperdiet neque. In vel congue ligula, sit amet dignissim ante.Aliquam non ornare lacus, vel gravida ex. Donec sed semper purus. Proin sagittis, ligula nec maximus consequat, ligula velit malesuada leo, quis malesuada tellus eros non quam. Donec dictum rhoncus ullamcorper. Donec ligula magna, maximus id ultricies quis, pulvinar pellentesque orci. Nunc sagittis porttitor tincidunt. Nulla sit amet quam molestie, venenatis nibh nec, ultricies odio. Mauris ex ligula, euismod ut commodo a, fringilla vel lorem. Nulla facilisi. Etiam at tempor ante, vel scelerisque metus. Nulla facilisi. Curabitur nec risus sem. Donec lorem nibh, malesuada vel felis quis, dapibus sagittis eros. In sed neque ac tellus porta varius id porttitor mauris. Donec quis sem nec velit dapibus aliquam.Morbi vitae velit laoreet, gravida purus at, pulvinar sapien. Vivamus laoreet justo at mauris finibus pulvinar. Sed ac nisl sit amet tortor pellentesque malesuada. Curabitur est ligula, euismod iaculis tellus auctor, commodo faucibus justo. Maecenas gravida interdum efficitur. Aliquam erat volutpat. Nullam massa urna, convallis non volutpat at, laoreet vel augue. Maecenas tincidunt condimentum ligula vitae eleifend. Nam vestibulum velit tellus, vitae tincidunt velit porttitor in. Quisque scelerisque nec metus sed scelerisque. Aliquam et venenatis metus, nec vulputate metus. Nam porta justo vitae ipsum porta molestie. Sed fringilla risus eu libero facilisis, vel porttitor enim dapibus. Fusce gravida quam felis, eget pretium dolor efficitur ut. Proin ornare sagittis est, sit amet ultricies metus aliquam vitae. Phasellus aliquam tellus et posuere viverra.Phasellus molestie posuere tincidunt. Duis interdum interdum nulla ut tristique. Sed in rhoncus massa, eget laoreet nisi. Aliquam sodales ornare orci ac rutrum. In aliquam lacinia dapibus. Proin nec nisi sit amet nisl placerat fringilla in vitae arcu. Suspendisse a blandit odio, at condimentum ex. Donec a felis et ex gravida molestie. Quisque a gravida orci.Aenean imperdiet, ante quis tristique laoreet, erat est tincidunt diam, ac pretium est mauris eu sem. Cras in neque neque. Phasellus finibus tellus rutrum felis fringilla, sed feugiat justo dignissim. Duis sollicitudin magna lorem, quis tristique justo suscipit a. Vestibulum ex augue, feugiat sit amet porttitor sit amet, tristique eget felis. Nam blandit lobortis porttitor. Aliquam eget condimentum purus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Cras scelerisque ligula id purus hendrerit, a viverra magna placerat. Mauris ornare rhoncus metus, vitae iaculis ante dapibus nec. Suspendisse pretium tincidunt massa, sit amet viverra ex. Phasellus egestas, massa sit amet ultrices facilisis, mi augue tempus velit, nec ullamcorper nibh nulla sit amet leo.Sed consectetur lorem a lacus sagittis, eget dignissim turpis finibus. Nunc lorem neque, ullamcorper non mauris ac, pharetra consequat nibh. Pellentesque eu tempor tellus. Aliquam luctus, augue eu porttitor volutpat, est nunc mattis massa, eget lacinia lectus ex eu arcu. Fusce id nunc ipsum. Aenean volutpat lorem vitae."
    #     language_model = BLOOM176bAPI("\n")
    #     new_prompt = language_model.preprocess_prompt(prompt)
    #     assert len(BloomTokenizerFast.from_pretrained("bigscience/bloom").decode(new_prompt)) <= 1000


